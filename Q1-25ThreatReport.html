<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Q1 2025 Cybersecurity Risk Assessment - Interactive Infographic</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://d3js.org/d3.v7.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js" xintegrity="sha512-GsLlZN/3F2ErC5ifS5QtgpiJtWd43JWSuIgh7mbzZ8zBps+dvLusV+eNQATqgA/HdeKFVgA5v3S/cIrLF7QnIg==" crossorigin="anonymous" referrerpolicy="no-referrer"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js" xintegrity="sha512-BNaRQnYJYiPSqHHDb58B0yaPfCu+Wgds8Gp/gU33kqBtgNS4tSPHuGibyoeqMV/TJlSKda6FXzoEyYGjTe+vXA==" crossorigin="anonymous" referrerpolicy="no-referrer"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f0f4f8; 
            color: #1a202c; 
        }
        .card {
            background-color: white;
            border-radius: 12px;
            padding: 24px;
            box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05);
            page-break-inside: avoid; 
            position: relative; 
             transition: transform 0.3s ease, box-shadow 0.3s ease;
        }
        .card:hover { 
            transform: translateY(-3px);
            box-shadow: 0 15px 20px -5px rgba(0, 0, 0, 0.1), 0 8px 10px -6px rgba(0, 0, 0, 0.1);
        }
        .tooltip { 
            position: absolute;
            text-align: center;
            padding: 8px;
            font-size: 12px;
            background: #334155; 
            color: white;
            border: 0px;
            border-radius: 8px;
            pointer-events: none;
            opacity: 0;
            transition: opacity 0.3s;
            z-index: 100; 
        }
        .stat-value {
            font-size: 2.5rem; 
            font-weight: 700;
            color: #2563eb; 
        }
        .stat-label {
            font-size: 0.9rem;
            color: #4a5568; 
            margin-top: 4px;
        }
        .section-title {
            font-size: 1.8rem;
            font-weight: 700;
            color: #1e3a8a; 
            margin-bottom: 20px;
            border-bottom: 2px solid #93c5fd; 
            padding-bottom: 8px;
            page-break-after: avoid; 
        }
        .chart-container { 
            position: relative;
            min-height: 350px; 
            background-color: #fff; 
            page-break-inside: avoid; 
            padding-bottom: 10px; 
        }
        .bar { 
            transition: fill 0.3s ease;
        }
        .bar:hover { 
            fill: #1d4ed8; 
        }
        .hover-reveal-details {
            background-color: #e0f2fe; 
            border-left: 4px solid #3b82f6; 
            padding: 12px;
            margin-top: 10px;
            border-radius: 6px;
            font-size: 0.8rem; 
            color: #1e3a8a;
            line-height: 1.5;
            page-break-inside: avoid;
        }
        .hover-reveal-details p {
            margin-bottom: 4px;
        }
        .hover-reveal-details p:last-child {
            margin-bottom: 0;
        }

        .download-button, .ai-button { 
            background-color: #1e40af; 
            color: white;
            padding: 10px 15px;
            border-radius: 8px;
            font-weight: 600;
            cursor: pointer;
            transition: background-color 0.3s ease;
            border: none;
            margin-left: 10px; 
        }
        .download-button:hover, .ai-button:hover {
            background-color: #1d3557; 
        }
        .ai-button-inline { /* For smaller buttons next to stats */
            background-color: #60a5fa; /* Lighter blue */
            color: white;
            padding: 4px 8px;
            border-radius: 6px;
            font-size: 0.75rem;
            margin-left: 8px;
            cursor: pointer;
            transition: background-color 0.3s ease;
        }
        .ai-button-inline:hover {
            background-color: #3b82f6; /* Darker blue */
        }
        
        .remove-from-export-js { 
            /* This class is targeted by JS to hide elements during export */
        }

        /* Modal Styles */
        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.6);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 1000;
            opacity: 0;
            visibility: hidden;
            transition: opacity 0.3s ease, visibility 0.3s ease;
        }
        .modal-overlay.active {
            opacity: 1;
            visibility: visible;
        }
        .modal-content {
            background-color: white;
            padding: 30px;
            border-radius: 10px;
            box-shadow: 0 5px 15px rgba(0,0,0,0.3);
            width: 90%;
            max-width: 600px;
            max-height: 80vh;
            overflow-y: auto;
            position: relative;
        }
        .modal-close-button {
            position: absolute;
            top: 15px;
            right: 15px;
            background: none;
            border: none;
            font-size: 1.8rem;
            cursor: pointer;
            color: #666;
        }
        .modal-title {
            font-size: 1.5rem;
            font-weight: 600;
            margin-bottom: 15px;
            color: #1e3a8a;
        }
        .modal-body {
            font-size: 0.95rem;
            line-height: 1.6;
            color: #333;
        }
        .loading-spinner {
            border: 4px solid #f3f3f3;
            border-top: 4px solid #3b82f6;
            border-radius: 50%;
            width: 30px;
            height: 30px;
            animation: spin 1s linear infinite;
            margin: 20px auto;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }


        @media print { 
            .no-print-css { 
                display: none !important;
            }
            body {
                background-color: #fff !important; 
                -webkit-print-color-adjust: exact !important; 
                print-color-adjust: exact !important; 
            }
            .card { 
                box-shadow: none !important;
                border: 1px solid #e2e8f0 !important;
                transform: none !important;
            }
            .card:hover { 
                transform: none !important;
                box-shadow: none !important;
            }
            .chart-container {
                background-color: #fff !important;
            }
            .chart-container svg { 
                background-color: #fff !important;
            }
            .hover-reveal-details, .modal-overlay { /* Ensure these are NOT printed */
                display: none !important;
            }
        }
    </style>
</head>
<body class="antialiased">
    <div class="container mx-auto p-4 md:p-8 max-w-6xl text-right">
        <button id="download-pdf-button" class="download-button no-print-css remove-from-export-js mb-4">Download as PDF</button>
        <button id="download-png-button" class="download-button no-print-css remove-from-export-js mb-4">Download as PNG</button>
    </div>

    <div id="infographic-content" class="container mx-auto p-4 md:p-8 max-w-6xl">
        <header class="text-center mb-12">
            <h1 class="text-4xl font-bold text-slate-800">Strategic Cybersecurity Threat Assessment</h1>
            <p class="text-2xl text-blue-600 font-semibold">Q1 2025 - Energy Sector Focus</p>
        </header>

        <div id="tooltip" class="tooltip remove-from-export-js"></div>

        <section id="global-threats" class="mb-12">
            <h2 class="section-title">Global Threat Landscape - Q1 2025</h2>
            <div class="grid md:grid-cols-3 gap-6">
                <div class="card text-center" id="overall-attacks-card">
                    <div class="flex justify-center items-center">
                        <div class="stat-value" id="overall-attacks-value">47%</div>
                        <button class="ai-button-inline remove-from-export-js" data-stat-type="overall_attacks" title="Explain this stat with AI">✨</button>
                    </div>
                    <div class="stat-label">YoY Increase in Weekly Cyberattacks per Organization</div>
                    <div class="hover-reveal-details hidden mt-3 remove-from-export-js">
                        <p>Avg. 1,925 attacks per org/week. [cite: 1, 53]</p>
                        <p>Source: Check Point Research [cite: 1]</p>
                    </div>
                </div>

                <div class="card text-center" id="ransomware-card">
                     <div class="flex justify-center items-center">
                        <div class="stat-value" id="ransomware-value">126%</div>
                        <button class="ai-button-inline remove-from-export-js" data-stat-type="ransomware" title="Explain this stat with AI">✨</button>
                    </div>
                    <div class="stat-label">YoY Increase in Ransomware Attacks</div>
                     <div class="hover-reveal-details hidden mt-3 remove-from-export-js">
                        <p>Over 2,063 publicly posted victims in Q1 2025 (historic high). [cite: 15, 53]</p>
                        <p>Ransomware in 44% of all breaches. [cite: 16, 53]</p>
                        <p>Sources: Check Point, GuidePoint, Verizon DBIR [cite: 15, 16, 53]</p>
                    </div>
                </div>

                <div class="card text-center" id="apt-card">
                    <div class="flex justify-center items-center">
                        <div class="stat-value" id="apt-value">136%</div>
                        <button class="ai-button-inline remove-from-export-js" data-stat-type="apt_attacks" title="Explain this stat with AI">✨</button>
                    </div>
                    <div class="stat-label">QoQ Increase in APT Attacks Targeting the U.S.</div>
                     <div class="hover-reveal-details hidden mt-3 remove-from-export-js">
                        <p>47% China-affiliated, 35% Russia-aligned. [cite: 20, 53]</p>
                        <p>Source: Trellix [cite: 20, 53]</p>
                    </div>
                </div>
            </div>
            <div class="text-center mt-6">
                <button id="summarize-global-risks" class="ai-button remove-from-export-js">Summarize Global Risks ✨</button>
            </div>
        </section>

        <section id="energy-sector" class="mb-12">
            <h2 class="section-title">Energy Sector Spotlight</h2>
            <div class="grid md:grid-cols-2 gap-6">
                <div class="card" id="utility-attacks-card">
                    <h3 class="text-xl font-semibold text-slate-700 mb-3">Attacks on U.S. Utilities</h3>
                    <div class="flex items-baseline">
                         <div class="stat-value text-red-600 mr-2" id="utility-attack-increase">~70%</div>
                         <button class="ai-button-inline remove-from-export-js" data-stat-type="us_utility_attacks" title="Explain this stat with AI">✨</button>
                    </div>
                    <div class="stat-label self-end">Increase from 2023 to 2024 [cite: 58]</div>
                    <p class="text-sm text-gray-600 mt-2">Signifying a clear upward trend leading into Q1 2025. [cite: 58]</p>
                    <div class="hover-reveal-details hidden mt-3 remove-from-export-js">
                        <p>Increased pressure from nation-state campaigns, AI-driven vulnerabilities, and ransomware. [cite: 58]</p>
                        <p>Source: Fortress Q1 2025 Report[cite: 58], Mattermost [cite: 58]</p>
                    </div>
                </div>

                <div class="card" id="ot-vulnerabilities-card">
                     <h3 class="text-xl font-semibold text-slate-700 mb-3">OT Device Vulnerabilities</h3>
                    <div class="flex items-baseline">
                        <div class="stat-value text-amber-600 mr-2" id="kev-ot-devices">12%</div>
                        <button class="ai-button-inline remove-from-export-js" data-stat-type="ot_kev" title="Explain this stat with AI">✨</button>
                    </div>
                    <div class="stat-label self-end">of OT Devices Scanned Contained Known Exploitable Vulnerabilities (KEVs) [cite: 73, 97]</div>
                     <div class="hover-reveal-details hidden mt-3 remove-from-export-js">
                        <p>40% of orgs had KEV-laden OT assets insecurely connected to the internet. [cite: 73]</p>
                        <p>7% of all OT devices had KEVs linked to ransomware campaigns. [cite: 73]</p>
                        <p>Source: Claroty [cite: 73]</p>
                    </div>
                </div>
            </div>
            <div class="card mt-6" id="apt-chart-card"> 
                <h3 class="text-xl font-semibold text-slate-700 mb-4">Nation-State APT Activity Targeting Energy (Q1 2025, U.S. Focus)</h3>
                <div id="apt-source-chart" class="chart-container"></div>
                 <div class="hover-reveal-details hidden mt-3 remove-from-export-js" id="apt-source-details-hover"> 
                    <p>This chart illustrates the attribution of Advanced Persistent Threat (APT) activity targeting the U.S. in Q1 2025. [cite: 63, 97] A significant portion is linked to nation-state actors. Data from Trellix. [cite: 63]</p>
                 </div>
            </div>
             <div class="text-center mt-6">
                <button id="summarize-energy-risks" class="ai-button remove-from-export-js">Summarize Energy Sector Risks ✨</button>
            </div>
        </section>

        <section id="it-vs-ot" class="mb-12">
            <h2 class="section-title">IT vs. OT Security: Diverging Priorities</h2>
            <div class="grid md:grid-cols-2 gap-6">
                <div class="card" id="it-priorities-card">
                    <h3 class="text-xl font-semibold text-sky-700 mb-3">IT Security Priorities (CIA Triad) [cite: 102]</h3>
                    <ul class="list-disc list-inside space-y-1 text-slate-600">
                        <li><strong>Confidentiality:</strong> Protecting data from unauthorized disclosure. [cite: 102]</li>
                        <li><strong>Integrity:</strong> Ensuring data accuracy and trustworthiness. [cite: 102]</li>
                        <li><strong>Availability:</strong> Keeping systems and data accessible. [cite: 102]</li>
                    </ul>
                    <div class="hover-reveal-details hidden mt-3 remove-from-export-js">
                        <p>Primary Risks: Data breaches, financial loss, reputational damage. [cite: 102]</p>
                    </div>
                </div>
                <div class="card" id="ot-priorities-card">
                    <h3 class="text-xl font-semibold text-emerald-700 mb-3">OT Security Priorities (Safety & Reliability) [cite: 102]</h3>
                    <ul class="list-disc list-inside space-y-1 text-slate-600">
                        <li><strong>Safety:</strong> Protecting personnel and the public. [cite: 102]</li>
                        <li><strong>Reliability:</strong> Ensuring continuous physical processes. [cite: 102]</li>
                        <li><strong>Availability:</strong> Maintaining essential services (power, water). [cite: 102]</li>
                    </ul>
                     <div class="hover-reveal-details hidden mt-3 remove-from-export-js">
                        <p>Primary Risks: Physical harm, environmental damage, service outages, societal impact. [cite: 103, 114]</p>
                        <p>57% of energy pros believe OT defenses lag IT (DNV, Mar 2025). [cite: 106]</p>
                    </div>
                </div>
            </div>
        </section>

        <footer class="text-center mt-12 py-6 border-t border-slate-300">
            <p class="text-sm text-slate-600">Infographic based on "A Strategic Cybersecurity Risk Assessment for Q1 2025 and the Energy Sector".</p>
            <p class="text-sm text-slate-500">Note: Data points are illustrative and derived from the provided report. For exact figures and full context, please refer to the original document.</p>
        </footer>
    </div>

    <div id="ai-modal-overlay" class="modal-overlay remove-from-export-js no-print-css">
        <div class="modal-content">
            <button id="ai-modal-close-button" class="modal-close-button">&times;</button>
            <h3 id="ai-modal-title" class="modal-title">AI Powered Insight ✨</h3>
            <div id="ai-modal-body" class="modal-body">
                <div class="loading-spinner"></div>
                </div>
        </div>
    </div>


    <script>
        document.addEventListener('DOMContentLoaded', function () {
            const tooltip = d3.select("#tooltip"); 

            // --- Hover-Reveal Logic ---
            const cardsWithHover = [
                'overall-attacks-card', 'ransomware-card', 'apt-card',
                'utility-attacks-card', 'ot-vulnerabilities-card',
                'apt-chart-card', 
                'it-priorities-card', 'ot-priorities-card'
            ];

            cardsWithHover.forEach(cardId => {
                const cardElement = document.getElementById(cardId);
                if (cardElement) {
                    const detailsElement = cardElement.querySelector('.hover-reveal-details');
                    if (detailsElement) {
                        cardElement.addEventListener('mouseenter', () => {
                            // Check if the element is currently being hidden for export
                            if (!detailsElement.classList.contains('js-export-hide')) {
                                detailsElement.classList.remove('hidden');
                            }
                        });
                        cardElement.addEventListener('mouseleave', () => {
                            detailsElement.classList.add('hidden');
                        });
                    }
                }
            });

            // Data for the APT chart
            const aptDataSource = [
                { group: "China-affiliated", value: 47, color: "#3b82f6" }, 
                { group: "Russia-aligned", value: 35, color: "#ef4444" }, 
                { group: "Other/Unknown", value: 18, color: "#a855f7" } 
            ];
            
            const aptChartContainer = document.getElementById('apt-source-chart');
            let xApt, yApt, svgApt, width, chartHeight, margin = { top: 20, right: 30, bottom: 70, left: 60 }; 

            function drawAptChart() {
                if (!aptChartContainer) {
                    console.error("APT chart container not found");
                    return;
                }
                aptChartContainer.innerHTML = ''; 

                const containerWidth = aptChartContainer.clientWidth;
                width = containerWidth - margin.left - margin.right;
                chartHeight = 250; 

                svgApt = d3.select("#apt-source-chart")
                    .append("svg")
                    .attr("width", width + margin.left + margin.right)
                    .attr("height", chartHeight + margin.top + margin.bottom) 
                    .append("g")
                    .attr("transform", `translate(${margin.left},${margin.top})`);

                xApt = d3.scaleBand()
                    .range([0, width])
                    .domain(aptDataSource.map(d => d.group))
                    .padding(0.3);

                svgApt.append("g")
                    .attr("class", "x-axis") 
                    .attr("transform", `translate(0,${chartHeight})`) 
                    .call(d3.axisBottom(xApt))
                    .selectAll("text")
                    .attr("transform", "translate(-10,0)rotate(-30)")
                    .style("text-anchor", "end")
                    .style("font-size", "12px");

                yApt = d3.scaleLinear()
                    .domain([0, d3.max(aptDataSource, d => d.value) + 5])
                    .range([chartHeight, 0]); 

                svgApt.append("g")
                    .attr("class", "y-axis") 
                    .call(d3.axisLeft(yApt).ticks(5).tickFormat(d => d + "%"))
                    .style("font-size", "12px");

                svgApt.append("text")
                    .attr("text-anchor", "middle")
                    .attr("x", width / 2)
                    .attr("y", chartHeight + margin.top + 45) 
                    .text("Attributed Actor Groups")
                    .style("font-size", "14px")
                    .style("fill", "#4A5568");

                svgApt.append("text")
                    .attr("text-anchor", "middle")
                    .attr("transform", "rotate(-90)")
                    .attr("y", -margin.left + 20)
                    .attr("x", -chartHeight / 2) 
                    .text("Percentage of Activity (%)")
                    .style("font-size", "14px")
                    .style("fill", "#4A5568");

                svgApt.selectAll(".bar")
                    .data(aptDataSource)
                    .enter()
                    .append("rect")
                    .attr("class", "bar")
                    .attr("x", d => xApt(d.group))
                    .attr("y", d => yApt(d.value))
                    .attr("width", xApt.bandwidth())
                    .attr("height", d => chartHeight - yApt(d.value)) 
                    .attr("fill", d => d.color)
                    .attr("rx", 4)
                    .on("mouseover", function (event, d) {
                        // Check if the tooltip itself is marked for removal from export
                        if (tooltip.node().classList.contains('remove-from-export-js') && tooltip.style('display') === 'none') return;
                        
                        d3.select(this).style("fill", d3.rgb(d.color).darker(0.7));
                        tooltip.transition().duration(200).style("opacity", .9);
                        tooltip.html(`<strong>${d.group}</strong><br/>${d.value}% of APT attacks`)
                            .style("left", (event.pageX + 5) + "px")
                            .style("top", (event.pageY - 28) + "px");
                    })
                    .on("mouseout", function (event, d) {
                        if (tooltip.node().classList.contains('remove-from-export-js') && tooltip.style('display') === 'none') return;
                        d3.select(this).style("fill", d.color);
                        tooltip.transition().duration(500).style("opacity", 0);
                    });
                
                svgApt.selectAll(".bar-label")
                    .data(aptDataSource)
                    .enter()
                    .append("text")
                    .attr("class", "bar-label")
                    .attr("x", d => xApt(d.group) + xApt.bandwidth() / 2)
                    .attr("y", d => yApt(d.value) - 5)
                    .attr("text-anchor", "middle")
                    .style("font-size", "12px")
                    .style("fill", "#1a202c")
                    .text(d => d.value + "%");
            }
            
            drawAptChart(); 

            const downloadPdfButton = document.getElementById('download-pdf-button');
            const downloadPngButton = document.getElementById('download-png-button');
            const contentToExport = document.getElementById('infographic-content');

            // --- AI Modal Elements and Functions ---
            const aiModalOverlay = document.getElementById('ai-modal-overlay');
            const aiModalCloseButton = document.getElementById('ai-modal-close-button');
            const aiModalTitle = document.getElementById('ai-modal-title');
            const aiModalBody = document.getElementById('ai-modal-body');
            const loadingSpinnerHTML = '<div class="loading-spinner"></div>';

            function openAiModal(title = "AI Powered Insight ✨") {
                aiModalTitle.textContent = title;
                aiModalBody.innerHTML = loadingSpinnerHTML; // Show spinner initially
                aiModalOverlay.classList.add('active');
            }

            function closeAiModal() {
                aiModalOverlay.classList.remove('active');
                aiModalBody.innerHTML = ''; // Clear content
            }

            if (aiModalCloseButton) {
                aiModalCloseButton.addEventListener('click', closeAiModal);
            }
            if (aiModalOverlay) {
                 aiModalOverlay.addEventListener('click', function(event) {
                    if (event.target === aiModalOverlay) { // Only close if overlay itself is clicked
                        closeAiModal();
                    }
                });
          
            <script>
  async function sendToGemini() {
    const userText = document.getElementById('inputText').value;
    const response = await fetch('https://<your-vercel-project>.vercel.app/api/gemini', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ text: userText })
    });

    const data = await response.json();
    document.getElementById('response').textContent = JSON.stringify(data, null, 2);
  }
</script>   
                try {
                    const response = await fetch(apiUrl, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(payload)
                    });
                    if (!response.ok) {
                        const errorData = await response.json();
                        console.error("Gemini API Error:", errorData);
                        return `Error: ${errorData.error?.message || response.statusText}`;
                    }
                    const result = await response.json();
                    if (result.candidates && result.candidates.length > 0 &&
                        result.candidates[0].content && result.candidates[0].content.parts &&
                        result.candidates[0].content.parts.length > 0) {
                        return result.candidates[0].content.parts[0].text;
                    } else {
                        console.error("Unexpected API response structure:", result);
                        return "Error: Could not retrieve a valid response from the AI.";
                    }
                } catch (error) {
                    console.error("Fetch error calling Gemini API:", error);
                    return "Error: Could not connect to the AI service.";
                }
            }

            // Event listeners for "Explain Stat" buttons
            document.querySelectorAll('.ai-button-inline').forEach(button => {
                button.addEventListener('click', async function() {
                    const statType = this.dataset.statType;
                    const card = this.closest('.card');
                    const statValueElement = card.querySelector('.stat-value');
                    const statLabelElement = card.querySelector('.stat-label');
                    const hoverRevealElement = card.querySelector('.hover-reveal-details');

                    let statText = `${statValueElement.textContent.trim()} ${statLabelElement.textContent.trim()}`;
                    let contextText = hoverRevealElement ? Array.from(hoverRevealElement.querySelectorAll('p')).map(p => p.textContent.trim()).join(' ') : '';
                    
                    let prompt = `Based on the Q1 2025 Cybersecurity Risk Assessment for the Energy Sector, explain the significance of the following statistic: "${statText}". Additional context: "${contextText}". Keep the explanation concise (2-3 sentences) and easy to understand for a general audience.`;
                    
                    openAiModal(`Explaining: ${statText}`);
                    const explanation = await callGeminiAPI(prompt);
                    aiModalBody.innerHTML = explanation.replace(/\n/g, '<br>');
                });
            });

            // Event listeners for "Summarize Risks" buttons
            document.getElementById('summarize-global-risks')?.addEventListener('click', async function() {
                const section = document.getElementById('global-threats');
                let sectionText = "Global Threat Landscape Q1 2025: ";
                section.querySelectorAll('.card').forEach(card => {
                    const statValue = card.querySelector('.stat-value')?.textContent.trim();
                    const statLabel = card.querySelector('.stat-label')?.textContent.trim();
                    const hoverDetails = card.querySelector('.hover-reveal-details');
                    sectionText += `${statValue} ${statLabel}. `;
                    if (hoverDetails) {
                         sectionText += Array.from(hoverDetails.querySelectorAll('p')).map(p => p.textContent.trim()).join(' ') + " ";
                    }
                });
                
                const prompt = `Based on the Q1 2025 Cybersecurity Risk Assessment for the Energy Sector, provide a concise summary (3-4 key bullet points) of the main cybersecurity risks highlighted in the Global Threat Landscape section, using the following information: "${sectionText.substring(0, 1500)}". Focus on the most critical risks.`; // Truncate for safety
                openAiModal("Summarizing Global Risks ✨");
                const summary = await callGeminiAPI(prompt);
                aiModalBody.innerHTML = summary.replace(/\n/g, '<br>');
            });

            document.getElementById('summarize-energy-risks')?.addEventListener('click', async function() {
                const section = document.getElementById('energy-sector');
                let sectionText = "Energy Sector Spotlight Q1 2025: ";
                 section.querySelectorAll('.card').forEach(card => {
                    const cardTitle = card.querySelector('h3')?.textContent.trim();
                    const statValue = card.querySelector('.stat-value')?.textContent.trim();
                    const statLabel = card.querySelector('.stat-label')?.textContent.trim();
                    const hoverDetails = card.querySelector('.hover-reveal-details');
                    sectionText += `${cardTitle || ''} - ${statValue || ''} ${statLabel || ''}. `;
                     if (hoverDetails) {
                         sectionText += Array.from(hoverDetails.querySelectorAll('p')).map(p => p.textContent.trim()).join(' ') + " ";
                    }
                });

                const prompt = `Based on the Q1 2025 Cybersecurity Risk Assessment for the Energy Sector, provide a concise summary (3-4 key bullet points) of the main cybersecurity risks highlighted in the Energy Sector Spotlight, using the following information: "${sectionText.substring(0, 1500)}". Focus on the most critical risks to utilities and OT systems.`; // Truncate
                openAiModal("Summarizing Energy Sector Risks ✨");
                const summary = await callGeminiAPI(prompt);
                aiModalBody.innerHTML = summary.replace(/\n/g, '<br>');
            });


            function prepareForExport() {
                const elementsToHide = document.querySelectorAll('.remove-from-export-js');
                const originalDisplays = new Map();
                elementsToHide.forEach(el => {
                    originalDisplays.set(el, el.style.display); 
                    el.style.display = 'none';
                    el.classList.add('js-export-hide'); 
                });
                return originalDisplays;
            }

            function restoreAfterExport(originalDisplays) {
                originalDisplays.forEach((display, el) => {
                    el.style.display = display;
                    el.classList.remove('js-export-hide'); 
                });
                // Ensure all hover-reveal details are reset to their default 'hidden' class state
                document.querySelectorAll('.hover-reveal-details.remove-from-export-js').forEach(hrd => {
                    // If it was hidden for export (js-export-hide was added),
                    // its display style is now restored by the loop above.
                    // Now, ensure the 'hidden' class is present for its default hover state.
                    if (!hrd.classList.contains('hidden')) {
                        hrd.classList.add('hidden');
                    }
                });
            }

            if (downloadPdfButton && contentToExport) {
                downloadPdfButton.addEventListener('click', function () {
                    const originalDisplays = prepareForExport();
                    const opt = {
                        margin:       [0.5, 0.5, 0.5, 0.5], 
                        filename:     'Q1_2025_Cybersecurity_Infographic.pdf',
                        image:        { type: 'jpeg', quality: 0.98 },
                        html2canvas:  { scale: 2, logging: false, useCORS: true, letterRendering: true, scrollY: 0, dpi: 192, removeContainer: true },
                        jsPDF:        { unit: 'in', format: 'letter', orientation: 'portrait' },
                        pagebreak:    { mode: ['avoid-all', 'css', 'legacy'] } 
                    };
                    html2pdf().from(contentToExport).set(opt).save().then(() => {
                        restoreAfterExport(originalDisplays);
                    }).catch(err => {
                        console.error("Error generating PDF:", err);
                        restoreAfterExport(originalDisplays);
                    });
                });
            }

            if (downloadPngButton && contentToExport) {
                downloadPngButton.addEventListener('click', function() {
                    const originalDisplays = prepareForExport();
                    html2canvas(contentToExport, { 
                        scale: 2, logging: false, useCORS: true, letterRendering: true, scrollY: -window.scrollY 
                    }).then(canvas => {
                        const imageURL = canvas.toDataURL('image/png');
                        const a = document.createElement('a');
                        a.href = imageURL;
                        a.download = 'Q1_2025_Cybersecurity_Infographic.png';
                        document.body.appendChild(a);
                        a.click();
                        document.body.removeChild(a);
                        restoreAfterExport(originalDisplays);
                    }).catch(err => {
                        console.error("Error generating PNG:", err);
                        restoreAfterExport(originalDisplays);
                    });
                });
            }
            
            function resizeCharts() { 
                if (aptChartContainer && xApt) { 
                    const newContainerWidth = aptChartContainer.clientWidth;
                    const newWidth = Math.max(0, newContainerWidth - margin.left - margin.right);

                    d3.select("#apt-source-chart svg")
                        .attr("width", newWidth + margin.left + margin.right);
                    
                    xApt.range([0, newWidth]);
                    
                    svgApt.select(".x-axis")
                        .call(d3.axisBottom(xApt))
                        .selectAll("text")
                        .attr("transform", "translate(-10,0)rotate(-30)")
                        .style("text-anchor", "end");
                    
                    svgApt.selectAll(".bar")
                        .attr("x", d => xApt(d.group))
                        .attr("width", xApt.bandwidth());

                    svgApt.selectAll(".bar-label")
                        .attr("x", d => xApt(d.group) + xApt.bandwidth() / 2);
                    
                    // Update X-axis label position
                    svgApt.select("text[text-anchor='middle'][y='" + (chartHeight + margin.top + 45) + "']") 
                        .attr("x", newWidth / 2);
                }
            }
            window.addEventListener('resize', resizeCharts); 
        });
    </script>
</body>
</html>
